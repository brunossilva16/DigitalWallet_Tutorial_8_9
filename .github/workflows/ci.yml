name: Python CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-24.04
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Configure PYTHONPATH
      run: |
        echo "PYTHONPATH=${{ github.workspace }}" >> $GITHUB_ENV
        echo "Current directory: $(pwd)"
        echo "Directory structure:"
        find . -type f -name "*.py" | head -20
        
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install pytest coverage mutmut pynguin
        
    - name: Debug - Show project structure
      run: |
        echo "=== Project Structure ==="
        ls -la
        echo ""
        echo "=== src directory ==="
        ls -la src/ 2>/dev/null || echo "src/ not found"
        echo ""
        echo "=== tests directory ==="
        ls -la tests/ 2>/dev/null || echo "tests/ not found"
        
    - name: Fix test imports (if needed)
      run: |
        # Corrige imports nos testes gerados
        if [ -f "tests/test_src_wallet.py" ]; then
          echo "Fixing imports in test files..."
          # Opção 1: Alterar import absoluto para relativo
          sed -i 's/import src.wallet as module_0/from src import wallet as module_0/g' tests/test_src_wallet.py 2>/dev/null || true
          # Opção 2: Adicionar sys.path
          sed -i '1i import sys\nsys.path.insert(0, ".")' tests/test_src_wallet.py 2>/dev/null || true
        fi
        
    - name: Generate tests with Pynguin
      env:
        PYNGUIN_DANGER_AWARE: 1
        PYTHONPATH: ${{ github.workspace }}
      run: |
        # Primeiro verifica se o módulo existe
        python -c "import sys; sys.path.insert(0, '.'); from src import wallet; print('Module found!')" 2>/dev/null || echo "Module check failed"
        
        # Gera testes
        pynguin --project-path . --module-name src.wallet --output-path tests --seed 42 || echo "Pynguin completed"
        
    - name: Run tests
      env:
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "Running tests with PYTHONPATH=$PYTHONPATH"
        pytest tests/ -v --import-mode=append
        
    - name: Run coverage
      env:
        PYTHONPATH: ${{ github.workspace }}
      run: |
        coverage run --branch -m pytest tests/ --import-mode=append
        coverage report -m
        coverage xml
        
    - name: Run mutation testing
      env:
        PYTHONPATH: ${{ github.workspace }}
      run: |
        mutmut run --paths-to-mutate src/wallet.py --runner "pytest tests/test_src_wallet.py --import-mode=append -x" || true
        mutmut html
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          coverage.xml
          htmlcov/
          mutation.html
